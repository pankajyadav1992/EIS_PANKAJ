@model EmployeeInformationSystem.Core.Models.EmployeeLeaveBalance
@{
    ViewBag.Title = "AddLeavesDue";
    //Layout = "~/Views/Shared/_Layout.cshtml";
}
@Styles.Render("~/Content/bootstrap-select")
@Styles.Render("~/Content/gijgo")
<header class="page-header @ViewBag.HeadingColor  text-white">
    <div class="container-fluid">
        <h2 class="no-margin-bottom">@ViewBag.HeadingName </h2>
    </div>
</header>
<section class="forms">
    @if (ViewBag.Msg == null)
    {
        <div class="container-fluid" style="position:relative">
            <div class="container-fluid">
                <div class="row" id="reportDisplayBlock">
                    <div class="col-lg-12">
                        <div class="card">
                            @using (Html.BeginForm("AddLeavesDue", "Leave", FormMethod.Post, new { @class = "form-horizontal", @data_heading = "Add Leave Type" }))
                            {
                                @Html.AntiForgeryToken()
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                                <div class="card-body">
                                    <div class="form-group row">
                                        <label class="form-control-label col-sm-3 d-flex justify-content-center">Employee Name</label>
                                        <div class="col-sm-4">
                                            <select name="EmployeeId" class="form-control select" id="selectEmployeeByName" style="min-width:80%;" data-live-search="true">
                                                <option value="0" selected>--Select Employee--</option>
                                                @foreach (var emp in ViewBag.EmlployeeTypeList)
                                                {
                                                    <option value="@emp.Id" data-employeetype="@emp.FirstName">@emp.FirstName @emp.MiddleName @emp.LastName</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-sm-4">
                                            <div classs="col-sm-9 align-left" style="display:none;color: red;" id="errorEmployeeId">Please Select Employee Name</div>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="form-control-label col-sm-3 d-flex justify-content-center">Leave Type</label>
                                        <div class="col-sm-4">
                                            <select name="LeaveTypeId" class="form-control" id="selectLeaveTypeName" style="min-width:80%;" data-live-search="true">
                                                <option value="0" selected>--Select Leave Type--</option>
                                               @*@foreach (var leave in ViewBag.TypeList)
                                                {
                                                    <option value="@leave.Id" data-employeetype="@leave.Name">@leave.Name</option>
                                                }*@
                                            </select>
                                        </div>
                                        <div class="col-sm-4">
                                            <div classs="col-sm-9 align-left" style="display:none;color: red;" id="errorLeaveId">Please Select Leave Type</div>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="form-control-label col-sm-3 d-flex justify-content-center">No of Leaves</label>
                                        <div class="col-sm-4">
                                            @Html.EditorFor(model => model.AvailableLeaveCount, new { htmlAttributes = new { @class = "form-control", @type = "number", @data_type = "number", autocomplete = "off" } })

                                        </div>
                                        <div class="col-sm-4">
                                            <div classs="col-sm-9 align-left" style="display:none;color: red;" id="errorNoOfDays">Please Enter No of Leaves</div>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-9 offset-sm-4">
                                            <input type="submit" value="Apply" class="btn btn-primary" id="ApplyLeaveBtn">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-8" id="tblCard" style="display:none">
                                            <table class="table table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Leave Type</th>
                                                        <th>No. of Leaves Due</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="TblLeaveData"></tbody>
                                            </table>
                                            </div>
                                    </div>                          
                        </div>
                            }
                    </div>
                </div>
            </div>
        </div>
        </div>
    }
    else
    {
        <div class="container-fluid" style="position:relative">
            <div class="container-fluid">
                <div class="row" id="reportDisplayBlock">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body" id="reportDisplayBody">
                                <p>@ViewBag.Msg</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</section>
@section Scripts{
    @Scripts.Render("~/bundles/bootstrap-select")
    @Scripts.Render("~/bundles/gijgo")
<script>
                            $(document).ready(function () {


                                $(document).on('change', '#selectEmployeeByName', function () {
                                  //  var empid = $(this).children(":selected").val();
                                    ////alert(empid);
                                     var data = {
                                         'EmployeeId': $("#selectEmployeeByName option:selected").val()    
                                                }              

                                    postData("Leave/Get_Leave_Employee ", data, "Leavedata", "Leave");
                                });

        $(document).on('click', '#ApplyLeaveBtn', function (e) {
           var isValid = true;
           var australianDate = /^(?=\d)(?:(?:31(?!.(?:0?[2469]|11))|(?:30|29)(?!.0?2)|29(?=.0?2.(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00)))(?:\x20|$))|(?:2[0-8]|1\d|0?[1-9]))([-./])(?:1[012]|0?[1-9])\1(?:1[6-9]|[2-9]\d)?\d\d(?:(?=\x20\d)\x20|$))?(((0?[1-9]|1[012])(:[0-5]\d){0,2}(\x20[AP]M))|([01]\d|2[0-3])(:[0-5]\d){1,2})?$|^$/;

            if ($("#selectEmployeeByName").val() == 0) {
                $("#errorEmployeeId").show();
                isValid = false;
            } else {
                $("#errorEmployeeId").hide();
            }


            if ($("#selectLeaveTypeName").val() == 0) {
                $("#errorLeaveId").show(); isValid = false;
            } else {
                $("#errorLeaveId").hide();
            }


            if ($("#@Html.IdFor(model => model.AvailableLeaveCount)").val() == "") {
                $("#errorNoOfDays").show(); isValid = false;
            }
            else { $("#errorNoOfDays").hide(); }



            if (!isValid) {
                e.preventDefault(); //prevent the default action
            } else {
                $('#overlay').fadeIn(); // show spinner
            }
            });

        });

</script>
    <script>

        var getUrl = window.location
        var aURL = getUrl.protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/')[1] + "/";


        function postData(api, inputData, aBy, aTyp) {
            $.ajax({
                type: "POST",
                url: aURL + api,
                data: JSON.stringify(inputData),
                dataType: "JSON",
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    PostDone(data, aBy, aTyp);
                },
                error: function (err) {
                    window.location.href = aURL;
                    //alert("Something went wrong");
                }
            });
        }


        PostDone = function (data, aBy, aTyp) {

            if (aTyp === "Leave") {
                if (aBy === "Leavedata") {
                    if (data.length > 0) {
                        $('#TblLeaveData').empty();
                        $('#tblCard').css('display', 'block');
                        $.each(data, function (Key, value) {
                            $('#TblLeaveData').append('<tr role="row"><td class="tableRow">' + value.LeaveType + '</td><td>' + value.LeaveCount + '</td></tr>');

                        });

                        var data = {
                            'EmployeeId': $("#selectEmployeeByName option:selected").val()
                        }
                        postData("Leave/Get_Leave_List_Employee ", data, "dropdown", "LeaveOrgReport");

                    }
                    else {
                        $('#TblLeaveData').empty();
                        $('#tblCard').css('display', 'block');
                        $('#TblLeaveData').append('<tr role="row"><td colspan="2" style="text-align:center"> No records found </td></tr>');


                    }
                    $('#overlay').fadeOut();
                }
            }
            if (aTyp === "LeaveOrgReport") {
                document.getElementById("selectLeaveTypeName").innerHTML = null;
                    if (aBy === "dropdown") {
                        var Items = "<option value=0>--Select Leave Type--</option>";
                        $('#selectLeaveTypeName').append(Items);
                        if (data) {                        
                       
                        $.each(data, function (Key, value) {
                            $('#selectLeaveTypeName').append(
                                $('<option></option>').val(value.LeaveTypeId).text(value.Name));
                        });
                    }
                }
            }
        }




    </script>
}


